---
title: "Arizona-Pesticide-Usage-Map"
author: "LT, MF"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    social: menu
    source_code: embed
    # https://github.com/walkerke/neighborhood_diversity
    theme: cerulean
---

```{r gloval, include=FALSE}
pacman::p_load(flexdashboard, shiny, leaflet, leafpop, leafem, mapview, dplyr, ggplot2, plotly, scales)

counties <- c("APACHE", "COCHISE","COCONINO", "GILA", "GRAHAM", "GREENLEE", "LA PAZ",
                        "MARICOPA", "MOHAVE", "NAVAJO", "PIMA","PINAL", "SANTA CRUZ", "YAVAPAI",
                        "YUMA")

ingredients <- c("BENSULIDE", "CHLORPYRIFOS",
                        "METHOMYL", "ACEPHATE","DIMETHOATE","MALATHION",
                        "PERMETHRIN","LAMBDA-CYHALOTHRIN", "ZETA-CYPERMETHRIN","DIAZINON",
                        "BIFENTHRIN","CARBARYL","METHYL PARATHION","ESFENVALERATE",
                        "TRIBUFOS", "ALDICARB", "OXAMYL", "FENPROPATHRIN", "ETHEPHON",
                        "BETA-CYFLUTHRIN")


# Read in data, and subset for the selected county
data <- readRDS(file = "./data/cleaned_pesticides.rds")
year <- read.csv(file ="./data/total_yearly.csv")
month <- read.csv(file ="./data/total_monthly.csv")

dat <- reactive({

  data %>% dplyr::filter(County == input$county & year == input$year & Active.Ingredient.new ==input$ingredient)
  
})

yearly <- reactive({

  year %>% dplyr::filter(County == input$county)
  
})

monthly <- reactive({

 month %>% dplyr::filter(County == input$county & year == input$year & Active.Ingredient.new ==input$ingredient)
  
})


# test
# p <- month %>% dplyr::filter(County == "YUMA" & year == 2006 & Active.Ingredient.new == "CHLORPYRIFOS") %>%
#     mutate(text = glue::glue("Month: {month}<br>Total: {round(total, 2)}")) %>%
#     ggplot(aes(month %>% as.factor(), total)) +
#                         geom_point() +
#                         geom_line(group=0) +
#                         xlab("Month") + ylab("Total pesticide usage (lbs)") +
#                         + theme_bw(axis.text.x = element_text(angle = 45))
# 
# ggplotly(p, source = 'source', tooltip = "text") %>%
#     layout(dragmode = 'lasso',
#            yaxis = list(title = 'Total pesticide usage (lbs)'),
#            margin = list(l = 100),
#            font = list(family = 'Open Sans', size = 16))
# dat <- data  %>% dplyr::filter(County == "YUMA" & year == 2006 & Active.Ingredient.new == "CHLORPYRIFOS")
# mapview(dat,
#           crs = 4269,
#           grid = FALSE,
#           zcol = "AI_amount",
#           popup = popupTable(dat, zcol = c("year",
#                                               "County",
#                                               "Crop.Name",
#                                               "Active.Ingredient.new",
#                                               "AI_amount")))
```


Sidebar {.sidebar}
======================================================================

```{r}
tags$br()
# Define inputs
# select county
selectInput(
            inputId = "county",
            label = "Explore county",
            choices = counties,
            selected = "YUMA",
            multiple = FALSE)
                                      
# select ingredient
selectInput(
            inputId = "ingredient",
            label = "Select an ingredient",
            choices = ingredients,
            selected = "CHLORPYRIFOS",
            multiple = FALSE)
                                      
# Year
# select mode
selectInput(
            inputId = "year",
            label = "Explore year",
            choices = 1992:2016,
            selected = 2006,
            multiple = FALSE)
                                      

```

Use the __Explore county__ tab to explore yearly and month pesticide usage for your chosen AZ county in 2020.  The map presents the selected pesticide usage in targeted county in a selected year, across our sampling sites in AZ. To learn more about the project, click the __About__ tab.  

Author: [Tuo Liu](https://tuo-liu.netlify.app), [Melissa Furlong](https://live-azs-furlonglab.pantheonsite.io)

Data sources: [AZARG](https://live-azs-furlonglab.pantheonsite.io), Arizona ARG

Explore county
======================================================================

Row {data-height=600}
----------------------------------------------------------------------

### Pesticide use by geo-code

```{r}
output$map <- renderLeaflet({
  d <- dat() 
 
  m <- mapview(d,
          crs = 4269,
          grid = FALSE,
          zcol = "AI_amount",
          popup = popupTable(d, zcol = c("year","County","Crop.Name",
                                           "Active.Ingredient.new","AI_amount")))
  m@map
})

leafletOutput('map')
```


Row
-------------------------------------

### Yearly pesticide usage
```{r}
# Here, we draw the yearly usage scatter plot with ggplotly
output$scatter1 <- renderPlotly({
  m1 <- yearly() %>% mutate(
  text = glue::glue("Year: {year}<br>Total: {round(total, 2)}"))


  p1 <- ggplot(m1, aes(year %>% as.factor(), total, text=text)) +
                        geom_point() +
                        geom_line(group=0) +
                        xlab("Year") + 
                        theme(axis.text.x = element_text(angle = 45))
    

   plotly::ggplotly(p1, source = 'source', tooltip = "text") %>%
   layout(dragmode = 'lasso',
   yaxis = list(title = 'Total yearly usage (lbs)'),
   font = list(size = 16))
})

plotlyOutput('scatter1')
```

### Monthly pesticide usage 
```{r}
# Here, we draw the monthly usage scatter plot with ggplotly
output$scatter2 <- renderPlotly({

  m2 <- monthly() %>%
    mutate(text = glue::glue(
      "Month: {month}<br>Total: {round(total, 2)}"
    )) %>% 
    ggplot(aes(month %>% as.factor(), total, text=text)) +
            geom_point() +
            geom_line(group=0) +
            xlab("Month") + 
            theme(axis.text.x = element_text(angle = 45))

  ggplotly(m2, source = 'source', tooltip = "text") %>%
    layout(dragmode = 'lasso',
           yaxis = list(title = 'Total monthly usage (lbs)'),
           font = list(size = 16)) 

})

plotlyOutput('scatter2')
```



About
============================================================================

This application is in support of the _Urban Studies_, ["Locating neighborhood diversity in the American Metropolis."](http://usj.sagepub.com/content/early/2016/04/29/0042098016643481.abstract)  The article analyzes geographic variations in neighborhood racial and ethnic diversity over time in large metropolitan areas in the United States.  As of August 2022, this application is updated with data from the 2020 Decennial US Census.  All data are standardized to 2010 Census tracts thanks to NHGIS.  

<!-- The key metric in this article is the neighborhood-level _entropy index_ (called "diversity score" in the application), which measures the degree of neighborhood diversity for six general racial/ethnic groups: non-Hispanic white, non-Hispanic black, Hispanic, Asian/Pacific Islander, Native American.  The entropy index $E$ is calculated as follows (Farrell and Lee 2011):   -->


To study how the total pesticide usage varies with geographical locationand time in the State of Arizona, the total pesticide usage in pounds are plotted against the geocode and time.   

This application allows visitors to explore this part of the paper interactively.  The article follows by using local exploratory spatial data analysis techniques to identify how spatial clusters of diversity have shifted over time; this will be the focus of a future application that corresponds to an extension of the study published in _Urban Studies._  


The application is built with the [Shiny](http://shiny.rstudio.com) framework for the [R programming language](https://www.r-project.org/). The application layout is produced with the [flexdashboard](http://rstudio.github.io/flexdashboard/index.html) package, and the charts and maps use [Plotly](http://plot.ly), [Leaflet.js](http://leafletjs.com/), and [ggplot2](http://ggplot2.org/), all accessed through their corresponding R packages.  Code for the application is available at [Github](https://github.com/TuoooLiu666/Arizona-Pesticide-Usage-Map).  

To learn more about my work, [visit my website](https://tuo-liu.netlify.app) or [connect with me on LinkedIn](https://www.linkedin.com/in/tuo-l-491782194/).  

